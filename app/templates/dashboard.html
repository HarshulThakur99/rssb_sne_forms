<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blood Camp Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="dashboard-page">

        <nav>
        <a href="{{ url_for('home') }}">
            <img src="{{ url_for('static', filename='images/rssb.jpg') }}" alt="Logo" class="nav-logo">
        </a>
        <div class="nav-center-links">
            {% if current_user.is_authenticated %}
                {# Show if user is admin or SNE Services Operator #}
                {% if current_user.role == 'admin' or current_user.role == 'sne_services_operator' %}
                <div class="dropdown">
                    <button class="dropbtn">SNE Services <i class="arrow down"></i></button>
                    <div class="dropdown-content">
                        {# SNE Module Links - Check granular permissions #}
                        {% if current_user.has_permission('access_sne_form') %}
                            <a href="{{ url_for('sne.form_page') }}">SNE Data Entry</a>
                        {% endif %}
                        {% if current_user.has_permission('access_sne_printer') %}
                            <a href="{{ url_for('sne.printer_page') }}">SNE Badge Printer</a>
                        {% endif %}
                        {% if current_user.has_permission('access_sne_edit') %}
                            <a href="{{ url_for('sne.edit_page') }}">SNE Edit Entry</a>
                        {% endif %}
                        
                        {# HR Separator - Show if there are both SNE and Attendant links the user can see #}
                        {% set can_see_sne_links = current_user.has_permission('access_sne_form') or current_user.has_permission('access_sne_printer') or current_user.has_permission('access_sne_edit') %}
                        {% set can_see_attendant_links = current_user.has_permission('access_attendant_form') or current_user.has_permission('access_attendant_printer') or current_user.has_permission('access_attendant_edit') %}
                        {% if can_see_sne_links and can_see_attendant_links %}
                            <hr style="margin: 5px 0; border-color: rgba(255,255,255,0.2);">
                        {% endif %}

                        {# Attendant Module Links - Check granular permissions #}
                        {% if current_user.has_permission('access_attendant_form') %}
                            <a href="{{ url_for('attendant.form_page') }}">Attendant Data Entry</a>
                        {% endif %}
                        {% if current_user.has_permission('access_attendant_printer') %}
                            <a href="{{ url_for('attendant.printer_page') }}">Attendant Badge Printer</a>
                        {% endif %}
                        {% if current_user.has_permission('access_attendant_edit') %}
                            <a href="{{ url_for('attendant.edit_page') }}">Attendant Edit Entry</a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                {# Show if user is admin or Baal Satsang Operator #}
                {% if current_user.role == 'admin' or current_user.role == 'baal_satsang_operator' %}
                <div class="dropdown">
                    <button class="dropbtn">Baal Satsang <i class="arrow down"></i></button>
                    <div class="dropdown-content">
                        {% if current_user.has_permission('access_baal_satsang_printer') %}
                            <a href="{{ url_for('baal_satsang.printer_page') }}">Token Printer</a>
                        {% endif %}
                        {% if current_user.has_permission('access_mobile_token_printer') %}
                            <a href="{{ url_for('mobile_token.printer_page') }}">Mobile Tokens</a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                {# Show if user is admin or Blood Camp Operator #}
                {% if current_user.role == 'admin' or current_user.role == 'blood_camp_operator' %}
                <div class="dropdown">
                    <button class="dropbtn">Blood Camp <i class="arrow down"></i></button>
                    <div class="dropdown-content">
                        {% if current_user.has_permission('access_blood_camp_form') %}
                            <a href="{{ url_for('blood_camp.form_page') }}">Donor Registration</a>
                        {% endif %}
                        {% if current_user.has_permission('access_blood_camp_status_update') %}
                            <a href="{{ url_for('blood_camp.status_page') }}">Donor Status Update</a>
                        {% endif %}
                        {% if current_user.has_permission('access_blood_camp_dashboard') %}
                            <a href="{{ url_for('blood_camp.dashboard_page') }}" class="active-dashboard">Dashboard</a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            {% else %}
                 <a href="{{ url_for('login') }}">Login</a>
            {% endif %}
        </div>
        {% if current_user.is_authenticated %}
            <div class="nav-user-info-right">
                <span>Welcome, {{ current_user.id }}!</span> | 
                <a href="{{ url_for('logout') }}">Logout</a>
            </div>
        {% endif %}
    </nav>



    <div class="container dashboard-container" role="region" aria-label="Blood Camp Dashboard Container">
        <header class="header-section" role="banner">
            <h1>Blood Camp Dashboard</h1>
            <p class="subtitle">Key metrics from the donation drive.</p>
            <h2 class="donation-location-heading" aria-label="Donation locations heading">Donation Locations</h2>
        </header>
        <main class="dashboard-main" aria-label="Donation metrics and charts">
            <section class="dashboard-filters" aria-label="Dashboard Filters">
                <form id="dashboard-filter-form" class="filter-form" onsubmit="event.preventDefault(); applyDateFilter();" aria-label="Filter metrics by date">
                    <label for="filter-date" class="filter-label">Filter by Date (YYYY-MM-DD)</label>
                    <div class="filter-controls">
                        <input type="date" id="filter-date" name="date" aria-label="Select a date to filter dashboard metrics">
                        <button type="button" class="filter-apply-btn" onclick="applyDateFilter()">Apply</button>
                        <button type="button" class="filter-reset-btn" onclick="resetDateFilter()" aria-label="Reset date filter">Reset</button>
                    </div>
                    <small class="filter-hint">Leave blank or reset to view overall cumulative metrics.</small>
                </form>
            </section>
            <div id="loading-message" role="status" aria-live="polite">Loading dashboard data...</div>
            <div id="error-message" role="alert" style="display: none;"></div>
            <section id="kpi-section" class="kpi-card-section" style="display: none;" aria-label="Key Performance Indicators">
                <div class="kpi-card" tabindex="0" aria-label="Registrations today">
                    <div class="kpi-icon" aria-hidden="true"><i class="fas fa-calendar-day"></i></div>
                    <div class="kpi-title">Registrations Today</div>
                    <div class="kpi-value" id="kpi-registrations-today">--</div>
                </div>
                <div class="kpi-card" tabindex="0" aria-label="Accepted donations total">
                    <div class="kpi-icon" aria-hidden="true"><i class="fas fa-heart-circle-check"></i></div>
                    <div class="kpi-title">Accepted Donations</div>
                    <div class="kpi-value" id="kpi-accepted-total">--</div>
                </div>
                <div class="kpi-card" tabindex="0" aria-label="Rejected donations total">
                    <div class="kpi-icon" aria-hidden="true"><i class="fas fa-heart-circle-xmark"></i></div>
                    <div class="kpi-title">Rejected Donations</div>
                    <div class="kpi-value" id="kpi-rejected-total">--</div>
                </div>
                <div class="kpi-card" tabindex="0" aria-label="Acceptance rate percentage">
                    <div class="kpi-icon" aria-hidden="true"><i class="fas fa-percentage"></i></div>
                    <div class="kpi-title">Acceptance Rate</div>
                    <div class="kpi-value" id="kpi-acceptance-rate">--<span class="unit">%</span></div>
                </div>
            </section>
            <section id="charts-grid" class="charts-grid" style="display: none;" aria-label="Visual data charts">
                <div class="chart-container" aria-labelledby="bloodGroupChartTitle">
                    <h2 class="chart-title" id="bloodGroupChartTitle">Blood Group Distribution</h2>
                    <div class="canvas-wrapper">
                        <canvas id="bloodGroupChart" aria-label="Blood group distribution chart" role="img"></canvas>
                    </div>
                </div>
                <div class="chart-container" aria-labelledby="genderChartTitle">
                    <h2 class="chart-title" id="genderChartTitle">Gender Distribution</h2>
                    <div class="canvas-wrapper">
                        <canvas id="genderChart" aria-label="Gender distribution chart" role="img"></canvas>
                    </div>
                </div>
                <div class="chart-container" aria-labelledby="ageGroupChartTitle">
                    <h2 class="chart-title" id="ageGroupChartTitle">Age Group Distribution</h2>
                    <div class="canvas-wrapper">
                        <canvas id="ageGroupChart" aria-label="Age group distribution chart" role="img"></canvas>
                    </div>
                </div>
                <div class="chart-container" aria-labelledby="statusChartTitle">
                    <h2 class="chart-title" id="statusChartTitle">Donation Status</h2>
                    <div class="canvas-wrapper">
                        <canvas id="statusChart" aria-label="Donation status chart" role="img"></canvas>
                    </div>
                </div>
                <div class="chart-container" aria-labelledby="rejectionReasonChartTitle">
                    <h2 class="chart-title" id="rejectionReasonChartTitle">Top Rejection Reasons</h2>
                    <div class="canvas-wrapper">
                        <canvas id="rejectionReasonChart" aria-label="Top rejection reasons chart" role="img"></canvas>
                    </div>
                </div>
                <div class="chart-container" aria-labelledby="communicationOptInChartTitle">
                    <h2 class="chart-title" id="communicationOptInChartTitle">Communication Preference</h2>
                    <div class="canvas-wrapper">
                        <canvas id="communicationOptInChart" aria-label="Communication opt-in preference chart" role="img"></canvas>
                    </div>
                </div>
            </section>
        </main>
        <footer class="footer-section" role="contentinfo">
            <p>&copy; {{ current_year }} RSSB. All rights reserved.</p>
        </footer>
    </div>


    <script>
        // Chart.js Configuration and Data Fetching
        const loadingMessage = document.getElementById('loading-message');
        const errorMessage = document.getElementById('error-message');
        const kpiSection = document.getElementById('kpi-section');
        const chartsGrid = document.getElementById('charts-grid');
    const donationLocationHeading = document.querySelector('.donation-location-heading');

        // KPI Elements
        const kpiRegToday = document.getElementById('kpi-registrations-today');
        const kpiAccepted = document.getElementById('kpi-accepted-total');
        const kpiRejected = document.getElementById('kpi-rejected-total');
        const kpiAcceptRate = document.getElementById('kpi-acceptance-rate');


        // Define reusable color palettes (same as before)
        const colorPaletteBlood = ['#8B0000', '#DC143C', '#FF6347', '#FF7F50', '#CD5C5C', '#F08080', '#E9967A', '#FA8072'];
        const colorPaletteGender = ['#4682B4', '#6495ED', '#87CEEB'];
        const colorPaletteAge = ['#3CB371', '#2E8B57', '#66CDAA', '#8FBC8F', '#98FB98', '#90EE90'];
        const statusColors = {'Accepted': '#22c55e', 'Rejected': '#ef4444', 'Other/Pending': '#f97316'};
        const communicationColors = {'Yes': '#14b8a6', 'No': '#f43f5e', 'Unknown': '#a1a1aa'};
        const reasonColors = ['#a855f7', '#ec4899', '#f59e0b', '#10b981', '#0ea5e9', '#6366f1', '#84cc16', '#d946ef'];

        // Chart instances
    let bloodGroupChartInstance, genderChartInstance, ageGroupChartInstance, statusChartInstance, rejectionReasonChartInstance, communicationOptInChartInstance;

        function destroyCharts() {
            if (bloodGroupChartInstance) bloodGroupChartInstance.destroy();
            if (genderChartInstance) genderChartInstance.destroy();
            if (ageGroupChartInstance) ageGroupChartInstance.destroy();
            if (statusChartInstance) statusChartInstance.destroy();
            if (rejectionReasonChartInstance) rejectionReasonChartInstance.destroy();
            if (communicationOptInChartInstance) communicationOptInChartInstance.destroy();
        }

        // --- Chart Creation Functions (Modified Options) ---

        // Function to create a Pie/Doughnut chart
        function createPieChart(ctx, labels, data, colors, title, chartType = 'doughnut') {
             const chartData = labels.map(label => data[label] || 0);
             const chartColors = labels.map(label => colors[label] || '#cccccc');

            return new Chart(ctx, {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: title, data: chartData, backgroundColor: chartColors,
                        borderColor: '#ffffff', borderWidth: 1 // Reduced border
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Crucial for fitting container height
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 10, boxWidth: 12, font: { size: 10 } } // Smaller legend
                        },
                        title: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed !== null) {
                                        const total = context.dataset.data.reduce((acc, value) => acc + value, 0);
                                        const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) + '%' : '0.0%';
                                        label += `${context.parsed} (${percentage})`;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

         // Function to create a Bar chart (Vertical or Horizontal)
        function createBarChart(ctx, labels, data, colors, title, isHorizontal = false) {
             const chartData = labels.map(label => data[label] || 0);
             const chartColors = Array.isArray(colors)
                 ? labels.map((_, index) => colors[index % colors.length]) // Cycle through array colors
                 : labels.map(label => colors[label] || '#cccccc'); // Map object colors

            return new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Count', data: chartData, backgroundColor: chartColors,
                        borderColor: chartColors.map(color => color + 'cc'), borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Crucial for fitting container height
                    indexAxis: isHorizontal ? 'y' : 'x',
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: { display: !isHorizontal, text: 'Count', font: { size: 10 } },
                            ticks: { font: { size: 10 } } // Smaller ticks
                        },
                        y: {
                             beginAtZero: true,
                             title: { display: isHorizontal, text: 'Category', font: { size: 10 } },
                             ticks: { font: { size: 10 } } // Smaller ticks
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: false },
                         tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    const value = isHorizontal ? context.parsed.x : context.parsed.y;
                                     if (value !== null) { label += value; }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }


        // Fetch data and initialize charts
        async function loadDashboard(selectedDate = '') {
            destroyCharts();
            loadingMessage.style.display = 'block';
            errorMessage.style.display = 'none';
            kpiSection.style.display = 'none';
            chartsGrid.style.display = 'none';

            try {
                const baseUrl = "{{ url_for('blood_camp.dashboard_data_route') }}";
                const url = selectedDate ? `${baseUrl}?date=${encodeURIComponent(selectedDate)}` : baseUrl;
                const response = await fetch(url);
                if (!response.ok) {
                    let errorMsg = `HTTP error! status: ${response.status}`;
                    try { const errorData = await response.json(); errorMsg = errorData.error || errorMsg; } catch (e) {}
                    throw new Error(errorMsg);
                }
                const data = await response.json();
                console.log("Dashboard Data Received:", data);

                loadingMessage.style.display = 'none';
                kpiSection.style.display = 'grid'; // Use grid display
                chartsGrid.style.display = 'grid'; // Use grid display

                // --- Populate KPIs ---
                kpiRegToday.textContent = data.kpis.registrations_today ?? '--';
                kpiAccepted.textContent = data.kpis.accepted_total ?? '--';
                kpiRejected.textContent = data.kpis.rejected_total ?? '--';
                kpiAcceptRate.innerHTML = `${data.kpis.acceptance_rate ?? '--'}<span class="unit">%</span>`;

                // --- Update Donation Locations Heading Dynamically ---
                if (donationLocationHeading) {
                    const locDist = data.donation_location_distribution || {};
                    const uniqueLocations = Object.keys(locDist).filter(l => l && l !== 'Unknown');
                    const totalLocations = uniqueLocations.length;
                    const baseText = 'Donation Locations';
                    if (totalLocations === 0) {
                        donationLocationHeading.textContent = `${baseText} (none recorded)`;
                    } else if (totalLocations === 1) {
                        donationLocationHeading.textContent = `${baseText}: ${uniqueLocations[0]}`;
                    } else {
                        // Sort by frequency (descending) then alphabetically for stable order
                        const sortedByFreq = uniqueLocations.sort((a,b) => {
                            const diff = (locDist[b]||0) - (locDist[a]||0);
                            return diff !== 0 ? diff : a.localeCompare(b);
                        });
                        const displayList = sortedByFreq.slice(0,5); // Limit to 5 names for brevity
                        const moreCount = totalLocations - displayList.length;
                        donationLocationHeading.textContent = `${baseText}: ${displayList.join(', ')}${moreCount>0 ? ' +' + moreCount + ' more' : ''}`;
                    }
                    if (data.filter_date) {
                        donationLocationHeading.textContent += ` (Date: ${data.filter_date})`;
                    }
                }


                // --- Create Charts ---
                // Helper to safely get 2d context
                const safeCtx = (id) => {
                    const el = document.getElementById(id);
                    return el ? el.getContext('2d') : null;
                };

                // Blood Group Chart
                const bgCtx = safeCtx('bloodGroupChart');
                if (bgCtx) {
                    const bgLabels = Object.keys(data.blood_group_distribution || {});
                    const bgData = data.blood_group_distribution || {};
                    const bgColors = {};
                    bgLabels.forEach((label, index) => { bgColors[label] = colorPaletteBlood[index % colorPaletteBlood.length]; });
                    if (bgLabels.length) {
                        bloodGroupChartInstance = createPieChart(bgCtx, bgLabels, bgData, bgColors, 'Blood Groups');
                    }
                }

                // Gender Chart
                const genderCtx = safeCtx('genderChart');
                if (genderCtx) {
                    const genderLabels = Object.keys(data.gender_distribution || {});
                    const genderData = data.gender_distribution || {};
                    const genderColors = {};
                    genderLabels.forEach((label, index) => { genderColors[label] = colorPaletteGender[index % colorPaletteGender.length]; });
                    if (genderLabels.length) {
                        genderChartInstance = createPieChart(genderCtx, genderLabels, genderData, genderColors, 'Gender', 'pie');
                    }
                }

                // Age Group Chart
                const ageCtx = safeCtx('ageGroupChart');
                if (ageCtx) {
                    const ageLabels = Object.keys(data.age_group_distribution || {});
                    const ageData = data.age_group_distribution || {};
                    const ageColors = {};
                    ageLabels.forEach((label, index) => { ageColors[label] = colorPaletteAge[index % colorPaletteAge.length]; });
                    if (ageLabels.length) {
                        ageGroupChartInstance = createBarChart(ageCtx, ageLabels, ageData, ageColors, 'Age Groups');
                    }
                }

                // Status Chart
                const statusCtx = safeCtx('statusChart');
                if (statusCtx) {
                    const statusLabels = Object.keys(data.status_counts || {});
                    const statusData = data.status_counts || {};
                    if (statusLabels.length) {
                        statusChartInstance = createBarChart(statusCtx, statusLabels, statusData, statusColors, 'Donation Status', true); // Horizontal
                    }
                }

                // Rejection Reason Chart
                const reasonCanvas = document.getElementById('rejectionReasonChart');
                const reasonCtx = safeCtx('rejectionReasonChart');
                if (reasonCanvas) {
                    const reasonLabels = Object.keys(data.rejection_reasons || {});
                    const reasonData = data.rejection_reasons || {};
                    // Remove any prior empty message
                    const container = reasonCanvas.closest('.chart-container');
                    if (container) {
                        const oldMsg = container.querySelector('.empty-message');
                        if (oldMsg) oldMsg.remove();
                    }
                    if (reasonCtx && reasonLabels.length > 0) {
                        rejectionReasonChartInstance = createBarChart(reasonCtx, reasonLabels, reasonData, reasonColors, 'Top Rejection Reasons', true);
                    } else if (container) {
                        const msg = document.createElement('p');
                        msg.className = 'empty-message';
                        msg.textContent = 'No rejection reasons recorded.';
                        container.appendChild(msg);
                    }
                }

                // Communication Opt-In Chart
                const commCtx = safeCtx('communicationOptInChart');
                if (commCtx) {
                    const commLabels = Object.keys(data.communication_opt_in || {});
                    const commData = data.communication_opt_in || {};
                    if (commLabels.length) {
                        communicationOptInChartInstance = createPieChart(commCtx, commLabels, commData, communicationColors, 'Communication Preference');
                    }
                }



            } catch (error) {
                console.error('Error loading dashboard data:', error);
                loadingMessage.style.display = 'none';
                kpiSection.style.display = 'none';
                chartsGrid.style.display = 'none';
                errorMessage.textContent = `Failed to load dashboard data: ${error.message}`;
                errorMessage.style.display = 'block';
            }
        }

        // Load the dashboard when the page loads
        window.addEventListener('load', loadDashboard);

        // Apply Date Filter
        function applyDateFilter() {
            const dateInput = document.getElementById('filter-date');
            const chosenDate = dateInput.value.trim();
            loadDashboard(chosenDate);
        }

        // Reset Date Filter
        function resetDateFilter() {
            const dateInput = document.getElementById('filter-date');
            dateInput.value = '';
            loadDashboard();
        }

    </script>

</body>
</html>